<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive 30-Day Challenge Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Energetic & Playful -->
    <!-- Application Structure Plan: The application is designed as an interactive dashboard. This structure was chosen over a linear infographic to better suit the task-oriented nature of a daily tracker. The user is immediately presented with an an overview of their progress (KPIs and charts) at the top, which provides instant feedback and motivation. Below, a grid of interactive day-cards allows for non-linear interaction, letting the user log progress for any day at any time. A dedicated, button-triggered "Prompt of the Day" feature makes the journaling task more engaging. This architecture prioritizes user interaction, real-time feedback, and clear status visualization, which is the most effective way to make a static plan like this consumable and motivating as a web application. -->
    <!-- Visualization & Content Choices:
        - Overall Progress: Goal: Inform -> Viz: Donut Chart (Chart.js) -> Interaction: Updates on task completion -> Justification: Excellent for showing part-to-whole percentage, providing a clear visual summary of completion.
        - Daily Progress: Goal: Inform/Track -> Viz: Bar Chart (Chart.js) -> Interaction: Updates on task completion -> Justification: Provides a clear, at-a-glance view of tasks completed for a single day.
        - KPIs (Days Completed, Workouts Logged): Goal: Inform -> Viz: Large Number Display (HTML/CSS) -> Interaction: Updates on task completion -> Justification: High-impact, immediate feedback on key metrics.
        - Daily Task Tracking: Goal: Organize/Interact -> Viz: Interactive Checklists in Cards (HTML/CSS/JS) -> Interaction: User clicks to check/uncheck tasks -> Justification: The most intuitive method for logging progress, making the core loop of the app simple and effective.
        - Journaling Prompts: Goal: Inform/Engage -> Viz: Modal Display (HTML/CSS/JS) -> Interaction: Button click reveals a single prompt -> Justification: Reduces overwhelm from a long list and creates a focused, daily action.
        - CONFIRMATION: NO SVG graphics used. NO Mermaid JS used.
    -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F9FA;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 350px;
        }
        .task-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .task-item:hover {
            background-color: #E2E8F0;
        }
        .task-item.completed {
            background-color: #A5B4FC;
            text-decoration: line-through;
            text-decoration-color: #364156;
            text-decoration-thickness: 2px;
            color: #364156;
            font-weight: 500;
        }
        .day-card {
            background-color: #FFFFFF;
            border: 2px solid #E2E8F0;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .day-card-completed {
            background-color: #E0E7FF;
            border-color: #6366F1;
        }
        .day-card-missed {
            background-color: #D1D5DB;
            border-color: #EF4444;
            opacity: 0.7;
        }
        #promptModal, #confirmModal, #workoutModal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        @keyframes glow-pulse {
            0% { box-shadow: 0 0 0px 0px #A5B4FC; }
            50% { box-shadow: 0 0 10px 5px #A5B4FC; }
            100% { box-shadow: 0 0 0px 0px #A5B4FC; }
        }
        .glowing-task {
            animation: glow-pulse 2s ease-in-out forwards;
        }
        .current-day-card {
            border-color: #F97316;
            animation: glow-pulse 2s infinite;
        }
        #confettiMessage {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 1rem 2rem;
            background-color: #6366F1;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            border-radius: 9999px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 50;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }
        .calendar-day-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            height: 6rem;
            border-radius: 0.75rem;
            background-color: #E2E8F0;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .calendar-day-card:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .calendar-day-card.completed-day {
            background-color: #A5B4FC;
            border-color: #6366F1;
        }
        .calendar-day-card.some-tasks-day {
            background-color: #D1D5DB;
            border-color: #9CA3AF;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-[#364156] tracking-tight drop-shadow-sm">30-Day Challenge Tracker</h1>
            <p class="text-lg text-[#7284A3] mt-3">Your interactive dashboard for building discipline and new habits.</p>
            <p id="current-date" class="text-sm text-gray-500 mt-1"></p>
        </header>

        <main>
            <section id="dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-lg flex flex-col justify-center items-center">
                    <h3 class="text-xl font-semibold text-[#364156] mb-2">Days Completed</h3>
                    <p id="days-completed" class="text-6xl font-extrabold text-[#6366F1]">0/30</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg flex flex-col justify-center items-center">
                    <h3 class="text-xl font-semibold text-[#364156] mb-2">Total Workouts</h3>
                    <p id="workouts-logged" class="text-6xl font-extrabold text-[#F97316]">0</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center">
                    <h3 class="text-xl font-semibold text-center text-[#364156] mb-4">Overall Progress</h3>
                    <p id="overall-progress-percentage" class="text-6xl font-extrabold text-[#6366F1]">0%</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center">
                    <h3 class="text-xl font-semibold text-center text-[#364156] mb-4">Daily Stoic Wisdom</h3>
                    <div id="stoic-quote" class="px-4 py-2 text-center text-gray-700 italic">
                        "The best revenge is to be unlike him who performed the injury."
                    </div>
                </div>
            </section>

            <section id="journaling" class="text-center mb-12">
                   <button id="prompt-btn" class="bg-[#6366F1] text-white font-bold py-4 px-8 rounded-full shadow-lg hover:bg-[#4338CA] transition-colors">
                     Get Today's Journal Prompt
                 </button>
            </section>

            <section id="daily-tracker" class="bg-white p-6 rounded-2xl shadow-lg mb-12">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-[#364156]">Daily Checklist</h2>
                    <div class="flex space-x-2">
                        <button id="view-past-btn" class="bg-[#A5B4FC] text-white font-bold py-2 px-4 rounded-full shadow-md hover:bg-[#6366F1] transition-colors">
                            View Past Days
                        </button>
                        <button id="view-toggle-btn" class="bg-[#7284A3] text-white font-bold py-2 px-4 rounded-full shadow-md hover:bg-[#364156] transition-colors">
                            View Calendar
                        </button>
                    </div>
                </div>

                <div id="days-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                </div>

                <div id="calendar-view" class="hidden">
                    <div class="calendar-grid text-sm text-center font-semibold text-gray-500 mb-2">
                        <span>Sun</span>
                        <span>Mon</span>
                        <span>Tue</span>
                        <span>Wed</span>
                        <span>Thu</span>
                        <span>Fri</span>
                        <span>Sat</span>
                    </div>
                    <div id="calendar-grid-days" class="calendar-grid">
                    </div>
                </div>
            </section>

              <footer class="text-center mt-12">
                <button id="reset-btn" class="text-sm text-gray-500 hover:text-red-600 hover:underline">Reset All Progress</button>
            </footer>

        </main>
    </div>

    <div id="confettiMessage" class="hidden"></div>

    <div id="promptModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full transform transition-transform duration-300 scale-95 modal-content">
            <h2 class="text-2xl font-bold text-[#364156] mb-4">Journal Prompt of the Day</h2>
            <p id="prompt-text" class="text-lg text-gray-700 mb-6"></p>
            <button id="close-modal-btn" class="bg-[#6366F1] text-white font-bold py-2 px-5 rounded-lg hover:bg-[#4338CA] transition-colors w-full">Close</button>
        </div>
    </div>
    
    <div id="workoutModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full transform transition-transform duration-300 scale-95 modal-content">
            <h2 class="text-2xl font-bold text-[#364156] mb-4">Select Today's Workout</h2>
            <ul id="workout-list" class="space-y-3 mb-6"></ul>
            <button id="close-workout-modal-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-5 rounded-lg hover:bg-gray-400 transition-colors w-full">Cancel</button>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full transform transition-transform duration-300 scale-95 modal-content text-center">
            <h2 class="text-2xl font-bold text-red-600 mb-4">Reset Progress</h2>
            <p class="text-lg text-gray-700 mb-6">Are you sure you want to reset all your progress? This cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-reset-btn" class="bg-red-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-red-700 transition-colors">Yes, Reset</button>
                <button id="cancel-reset-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-5 rounded-lg hover:bg-gray-400 transition-colors">Cancel</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const workoutSchedule = [
                'Strength: Lower Body & Core', 'Strength: Upper Body', 'Rest Day: Stretching or Yoga', 'Strength: Full Body', 'Strength: Lower Body & Core', 'Rest Day: Stretching or Yoga', 'Strength: Upper Body', 'Strength: Full Body', 'Rest Day: Stretching or Yoga', 'Strength: Lower Body & Core', 'Strength: Upper Body', 'Strength: Full Body', 'Rest Day: Stretching or Yoga', 'Strength: Lower Body & Core', 'Strength: Upper Body', 'Rest Day: Stretching or Yoga', 'Strength: Full Body', 'Strength: Lower Body & Core', 'Strength: Upper Body', 'Rest Day: Stretching or Yoga', 'Strength: Full Body', 'Strength: Lower Body & Core', 'Rest Day: Stretching or Yoga', 'Strength: Upper Body', 'Strength: Full Body', 'Rest Day: Stretching or Yoga', 'Strength: Lower Body & Core', 'Strength: Upper Body', 'Rest Day: Stretching or Yoga', 'Strength: Full Body',
            ];
            
            const workoutOptions = [
                'Strength: Lower Body & Core', 'Strength: Upper Body', 'Strength: Full Body', 'Rest Day: Stretching or Yoga'
            ];

            const challengeData = {
                journalPrompts: [
                    "What is one small win I had today that I'm proud of?",
                    "How did I handle a moment of stress or discomfort today?",
                    "What is a new skill or piece of knowledge I gained today?",
                    "What is one act of kindness I showed myself today?",
                    "If I could give myself advice at the start of this challenge, what would it be?",
                    "What is one thing I am grateful for right now, big or small?",
                    "How has my perspective on challenges shifted since starting this journey?",
                    "Describe a moment today when I was fully present and engaged.",
                    "What feelings came up for me during my workout today?",
                    "What is one positive thought I can focus on for the rest of the day?",
                    "How did my mindset affect my performance today?",
                    "What is one habit I've started that I want to continue after this challenge?",
                    "What is a lesson I can take away from a difficult moment today?",
                    "How am I building resilience with each day of this challenge?",
                    "What is one thing I am looking forward to tomorrow?",
                    "What physical improvements have I noticed so far?",
                    "What's one thing I can do to take better care of my mental health today?",
                    "How has my body's relationship with food or exercise changed?",
                    "What is one fear or self-doubt I am working to overcome?",
                    "How can I celebrate my progress, no matter how small?",
                    "What's one thing I learned about myself today?",
                    "How does this challenge align with my long-term goals?",
                    "What is one thing I can simplify in my life right now?",
                    "How did I show up for myself today?",
                    "What is a personal truth that this challenge has revealed to me?",
                    "What is one thing I can forgive myself for today?",
                    "What is a limiting belief that is holding me back, and how can I challenge it?",
                    "Looking back, what has been the most significant change I've experienced?",
                    "How can I bring more mindfulness into my daily routine?",
                    "What is one promise I can make to myself for the final days of the challenge?"
                ],
                stoicQuotes: [
                    "The best revenge is to be unlike him who performed the injury. - Marcus Aurelius",
                    "We suffer more often in imagination than in reality. - Seneca",
                    "Waste no more time arguing about what a good man should be. Be one. - Marcus Aurelius",
                    "Hang on to your youthful enthusiasms - you’ll be able to use them better later. - Seneca",
                    "Do not spoil what you have by desiring what you have not; remember that what you now have was once among the things you only hoped for. - Epicurus",
                    "If you are distressed by anything external, the pain is not due to the thing itself, but to your estimate of it; and this you have the power to revoke at any time. - Marcus Aurelius",
                    "Luck is what happens when preparation meets opportunity. - Seneca",
                    "The mind that is anxious about future events is miserable. - Seneca",
                    "The soul becomes dyed with the color of its thoughts. - Marcus Aurelius",
                    "First say to yourself what you would be; and then do what you have to do. - Epictetus",
                    "It is not that we have a short time to live, but that we waste a lot of it. - Seneca",
                    "Difficulties strengthen the mind, as labor does the body. - Seneca",
                    "Never let the future disturb you. You will meet it, if you have to, with the same weapons of reason which today arm you against the present. - Marcus Aurelius",
                    "The whole future lies in uncertainty: live immediately. - Seneca",
                    "He who fears death will never do anything worthy of a living man. - Seneca",
                    "You have power over your mind - not outside events. Realize this, and you will find strength. - Marcus Aurelius",
                    "The greatest wealth is to live content with little. - Plato",
                    "It is not what happens to you, but how you react to it that matters. - Epictetus",
                    "Freedom is the only worthy goal in life. It is won by disregarding things that lie beyond our control. - Epictetus",
                    "Every difficulty in life is an opportunity to grow. - Epictetus",
                    "Man is not worried by real problems so much as by his imagined anxieties about real problems. - Epictetus",
                    "The tranquility that comes when you stop caring what they say. Or think. Or do. Only what you do. - Marcus Aurelius",
                    "Stop telling yourself the stories that keep you stuck. - Epictetus",
                    "No person has the power to have everything they desire, but it is in their power not to want what they don't possess, and to cheerfully turn what is given to their advantage. - Seneca",
                    "External things are not my problems. Only my own judgments are. - Marcus Aurelius",
                    "You must unlearn what you have learned. - Epictetus",
                    "If a man knows not to which port he sails, no wind is favorable. - Seneca",
                    "How long are you going to wait before you demand the best for yourself? - Epictetus",
                    "The things you think about determine the quality of your mind. Your soul takes on the color of your thoughts. - Marcus Aurelius",
                    "It is not the man who has too little, but the man who craves more, that is poor. - Seneca"
                ],
                confettiMessages: [
                    "You did it!",
                    "Keep up the great work!",
                    "Another day, another win!",
                    "Day completed!",
                    "Great job!",
                    "Progress, not perfection."
                ]
            };

            let progressData;
            let overallProgressChart;
            let isCalendarView = false;
            let currentDayView = 1;
            let showAllDays = false;

            // New variable to store the start date of the challenge
            let challengeStartDate;

            // Function to shuffle an array (Fisher-Yates algorithm)
            function shuffleArray(array) {
                let shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            function initializeProgress() {
                const defaultProgress = Array.from({ length: 30 }, (_, i) => ({
                    day: i + 1,
                    tasks: {
                        strength: false,
                        cardio: false,
                        read: false,
                        journal: false
                    },
                    strengthWorkoutOverride: null,
                    missed: false
                }));

                const savedProgress = localStorage.getItem('challengeProgress');
                const savedPrompts = localStorage.getItem('shuffledJournalPrompts');
                const savedQuotes = localStorage.getItem('shuffledStoicQuotes');
                
                if (savedProgress) {
                    progressData = JSON.parse(savedProgress);
                    challengeData.journalPrompts = JSON.parse(savedPrompts);
                    challengeData.stoicQuotes = JSON.parse(savedQuotes);
                } else {
                    progressData = defaultProgress;
                    challengeData.journalPrompts = shuffleArray(challengeData.journalPrompts);
                    challengeData.stoicQuotes = shuffleArray(challengeData.stoicQuotes);
                    localStorage.setItem('shuffledJournalPrompts', JSON.stringify(challengeData.journalPrompts));
                    localStorage.setItem('shuffledStoicQuotes', JSON.stringify(challengeData.stoicQuotes));
                }

                // Initialize or retrieve challenge start date
                const savedStartDate = localStorage.getItem('challengeStartDate');
                if (!savedStartDate) {
                    challengeStartDate = new Date().toISOString().slice(0, 10); // YYYY-MM-DD format
                    localStorage.setItem('challengeStartDate', challengeStartDate);
                } else {
                    challengeStartDate = savedStartDate;
                }
            }

            function saveProgress() {
                localStorage.setItem('challengeProgress', JSON.stringify(progressData));
            }

            function updateDashboard() {
                const daysCompleted = progressData.filter(day => Object.values(day.tasks).every(t => t)).length;
                const totalWorkouts = progressData.reduce((acc, day, index) => {
                    if (day.tasks.strength) {
                        acc++;
                    }
                    if (day.tasks.cardio) {
                        acc++;
                    }
                    return acc;
                }, 0);

                const daysCompletedEl = document.getElementById('days-completed');
                const workoutsLoggedEl = document.getElementById('workouts-logged');
                if (daysCompletedEl && workoutsLoggedEl) {
                    daysCompletedEl.textContent = `${daysCompleted}/30`;
                    workoutsLoggedEl.textContent = totalWorkouts;
                }

                updateOverallProgressChart();
                updateStoicQuote();
                updateCurrentDate();

                if (isCalendarView) {
                    renderCalendarView();
                } else {
                    renderDayGrid();
                }
            }

            function renderDayGrid() {
                const grid = document.getElementById('days-grid');
                if (!grid) return;
                grid.innerHTML = '';

                // Calculate the current challenge day based on the start date
                const today = new Date();
                const startDate = new Date(challengeStartDate);
                const challengeDay = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;

                progressData.forEach((dayData, index) => {
                    const allTasksDone = Object.values(dayData.tasks).every(t => t);
                    const isPastDay = dayData.day < challengeDay;

                    // New logic to hide completed or missed days
                    if (!showAllDays && (allTasksDone || dayData.missed)) {
                        return; // Skip rendering this tile
                    }

                    const isCurrentDay = dayData.day === challengeDay;

                    const strengthTaskLabel = dayData.strengthWorkoutOverride ? `${dayData.strengthWorkoutOverride} (Modified)` : workoutSchedule[index];

                    const dayCard = document.createElement('div');
                    dayCard.className = `day-card rounded-2xl shadow-lg p-6 flex flex-col justify-between ${isCurrentDay ? 'current-day-card' : ''} ${dayData.missed ? 'day-card-missed' : ''}`;

                    let tasksHtml = `
                        <div>
                            <h4 class="font-bold text-xl text-center mb-3 text-[#364156]" data-day="${index + 1}">Day ${dayData.day}</h4>
                            <ul class="space-y-2">
                                <li class="task-item flex items-center gap-2 rounded-lg cursor-pointer ${dayData.tasks.strength ? 'completed' : 'bg-gray-50'}" data-day="${index}" data-task="strength">
                                    <span class="text-sm font-semibold text-[#364156]">${strengthTaskLabel}</span>
                                </li>
                                <li class="task-item flex items-center gap-2 rounded-lg cursor-pointer ${dayData.tasks.cardio ? 'completed' : 'bg-gray-50'}" data-day="${index}" data-task="cardio">
                                    <span class="text-sm font-semibold text-[#364156]">Cardio or walk</span>
                                </li>
                                <li class="task-item flex items-center gap-2 rounded-lg cursor-pointer ${dayData.tasks.read ? 'completed' : 'bg-gray-50'}" data-day="${index}" data-task="read">
                                    <span class="text-sm font-semibold text-[#364156]">Read or Coursera</span>
                                </li>
                                <li class="task-item flex items-center gap-2 rounded-lg cursor-pointer ${dayData.tasks.journal ? 'completed' : 'bg-gray-50'}" data-day="${index}" data-task="journal">
                                    <span class="text-sm font-semibold text-[#364156]">Journal</span>
                                </li>
                            </ul>
                        </div>
                    `;

                    // Add "Mark as Missed" button for past, incomplete days
                    if (isPastDay && !allTasksDone) {
                       tasksHtml += `
                           <div class="mt-4 flex justify-center">
                               <button class="mark-missed-btn bg-gray-400 text-white text-xs font-bold py-2 px-4 rounded-full shadow-md hover:bg-red-500 transition-colors" data-day-index="${index}">Mark as Missed</button>
                           </div>
                       `;
                    }
                    
                    // Add "Change Workout" button for the current day
                    if (isCurrentDay && !allTasksDone) {
                        tasksHtml += `
                            <div class="mt-4 flex justify-center">
                                <button class="change-workout-btn bg-[#F97316] text-white text-xs font-bold py-2 px-4 rounded-full shadow-md hover:bg-orange-600 transition-colors" data-day-index="${index}">Change Workout</button>
                            </div>
                        `;
                    }

                    dayCard.innerHTML = tasksHtml;
                    grid.appendChild(dayCard);
                });
            }

            function renderCalendarView() {
                const grid = document.getElementById('calendar-grid-days');
                if (!grid) return;
                grid.innerHTML = '';
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).getDay(); // 0 for Sunday

                for (let i = 0; i < firstDayOfMonth; i++) {
                    grid.innerHTML += `<div class="calendar-day-card"></div>`;
                }

                progressData.forEach((dayData, index) => {
                    const allTasksDone = Object.values(dayData.tasks).every(t => t);
                    const someTasksDone = Object.values(dayData.tasks).some(t => t);
                    let cardClass = '';
                    if (allTasksDone) {
                        cardClass = 'completed-day';
                    } else if (someTasksDone) {
                        cardClass = 'some-tasks-day';
                    }
                    grid.innerHTML += `
                        <div class="calendar-day-card ${cardClass}" data-day="${index + 1}">
                            <span class="text-2xl font-bold">${dayData.day}</span>
                        </div>
                    `;
                });
            }
            
            function openWorkoutModal(dayIndex) {
                const modal = document.getElementById('workoutModal');
                const workoutList = document.getElementById('workout-list');
                if (!modal || !workoutList) return;
                
                workoutList.innerHTML = '';
                
                let lastWorkoutType = null;
                if (dayIndex > 0) {
                    const prevDay = progressData[dayIndex - 1];
                    lastWorkoutType = prevDay.strengthWorkoutOverride || workoutSchedule[dayIndex - 1];
                }

                workoutOptions.forEach(option => {
                    const listItem = document.createElement('li');
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.className = 'w-full text-left p-3 rounded-lg font-semibold transition-colors';
                    button.dataset.workoutType = option;
                    
                    if (option === lastWorkoutType) {
                        button.disabled = true;
                        button.className += ' bg-gray-200 text-gray-400 cursor-not-allowed';
                    } else {
                        button.className += ' bg-blue-100 text-blue-800 hover:bg-blue-200';
                    }
                    
                    listItem.appendChild(button);
                    workoutList.appendChild(listItem);
                });
                
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
            }

            function setupEventListeners() {
                const daysGrid = document.getElementById('days-grid');
                const calendarView = document.getElementById('calendar-view');
                const resetBtn = document.getElementById('reset-btn');
                const promptBtn = document.getElementById('prompt-btn');
                const closeModalBtn = document.getElementById('close-modal-btn');
                const modal = document.getElementById('promptModal');
                const confettiMessageEl = document.getElementById('confettiMessage');
                const viewToggleBtn = document.getElementById('view-toggle-btn');
                const mainGridView = document.getElementById('days-grid');
                const calendarGridDays = document.getElementById('calendar-grid-days');
                const workoutModal = document.getElementById('workoutModal');
                const closeWorkoutModalBtn = document.getElementById('close-workout-modal-btn');
                const workoutList = document.getElementById('workout-list');
                const viewPastBtn = document.getElementById('view-past-btn');

                if (viewPastBtn) {
                    viewPastBtn.addEventListener('click', () => {
                        showAllDays = !showAllDays;
                        renderDayGrid();
                        viewPastBtn.textContent = showAllDays ? 'Hide Past Days' : 'View Past Days';
                    });
                }


                if(viewToggleBtn) {
                    viewToggleBtn.addEventListener('click', () => {
                        isCalendarView = !isCalendarView;
                        if (isCalendarView) {
                            mainGridView.classList.add('hidden');
                            calendarView.classList.remove('hidden');
                            renderCalendarView();
                            viewToggleBtn.textContent = 'List View';
                        } else {
                            mainGridView.classList.remove('hidden');
                            calendarView.classList.add('hidden');
                            renderDayGrid();
                            viewToggleBtn.textContent = 'Calendar View';
                        }
                    });
                }

                if(calendarGridDays) {
                    calendarGridDays.addEventListener('click', (e) => {
                        const target = e.target.closest('.calendar-day-card');
                        if (target) {
                            currentDayView = parseInt(target.dataset.day);
                            mainGridView.classList.remove('hidden');
                            calendarView.classList.add('hidden');
                            renderDayGrid();
                            viewToggleBtn.textContent = 'Calendar View';

                            // Scroll to the specific day's card
                            const cardToScrollTo = document.querySelector(`.day-card h4.text-xl[data-day='${currentDayView}']`);
                            if (cardToScrollTo) {
                                cardToScrollTo.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }
                    });
                }

                if (daysGrid) {
                    daysGrid.addEventListener('click', (e) => {
                        const target = e.target.closest('.task-item');
                        const missedBtn = e.target.closest('.mark-missed-btn');
                        const changeWorkoutBtn = e.target.closest('.change-workout-btn');

                        if (target) {
                            const dayIndex = parseInt(target.dataset.day);
                            const taskType = target.dataset.task;

                            progressData[dayIndex].tasks[taskType] = !progressData[dayIndex].tasks[taskType];

                            if (progressData[dayIndex].tasks[taskType]) {
                                target.classList.add('glowing-task');
                                setTimeout(() => {
                                    target.classList.remove('glowing-task');
                                }, 2000);
                            }

                            const allTasksDone = Object.values(progressData[dayIndex].tasks).every(t => t);
                            if (allTasksDone) {
                                confetti({
                                    particleCount: 150,
                                    spread: 90,
                                    origin: { y: 0.6 }
                                });
                                showConfettiMessage();
                            }

                            saveProgress();
                            renderDayGrid();
                            updateDashboard();
                        } else if (missedBtn) {
                            const dayIndex = parseInt(missedBtn.dataset.dayIndex);
                            progressData[dayIndex].missed = true;
                            Object.keys(progressData[dayIndex].tasks).forEach(task => progressData[dayIndex].tasks[task] = true);
                            saveProgress();
                            renderDayGrid();
                            updateDashboard();
                        } else if (changeWorkoutBtn) {
                             const dayIndex = parseInt(changeWorkoutBtn.dataset.dayIndex);
                             openWorkoutModal(dayIndex);
                        }
                    });
                }
                
                if (workoutList) {
                    workoutList.addEventListener('click', (e) => {
                        const button = e.target.closest('button');
                        if (button && !button.disabled) {
                            const dayIndex = Array.from(document.querySelectorAll('.change-workout-btn')).find(btn => btn.closest('.day-card.current-day-card')).dataset.dayIndex;
                            const newWorkoutType = button.dataset.workoutType;
                            progressData[dayIndex].strengthWorkoutOverride = newWorkoutType;
                            saveProgress();
                            closeModal(workoutModal);
                            renderDayGrid();
                            updateDashboard();
                        }
                    });
                }
                
                if (closeWorkoutModalBtn) {
                     closeWorkoutModalBtn.addEventListener('click', () => {
                         closeModal(workoutModal);
                     });
                 }
                
                if (workoutModal) {
                    workoutModal.addEventListener('click', (e) => {
                        if (e.target === workoutModal) {
                            closeModal(workoutModal);
                        }
                    });
                }

                if (resetBtn) {
                    resetBtn.addEventListener('click', showConfirmModal);
                }

                try {
                    promptBtn.addEventListener('click', () => {
                        setupModal(modal, closeModalBtn);
                    });
                    closeModalBtn.addEventListener('click', () => {
                        closeModal(modal);
                    });
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            closeModal(modal);
                        }
                    });
                } catch(error) {
                    console.error('Error setting up modal event listeners:', error);
                }

                setupConfirmModal();
            }

            function setupModal(modal, closeBtn) {
                 const promptText = document.getElementById('prompt-text');
                 const modalContent = modal ? modal.querySelector('div') : null;

                 const today = new Date();
                 const startDate = new Date(challengeStartDate);
                 const challengeDay = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
                 const promptIndex = Math.min(challengeDay - 1, challengeData.journalPrompts.length - 1);
                 
                 if (promptText) {
                     promptText.textContent = challengeData.journalPrompts[promptIndex];
                 }
                 modal.classList.remove('hidden');
                 setTimeout(() => {
                     modal.classList.remove('opacity-0');
                     if (modalContent) modalContent.classList.remove('scale-95');
                 }, 10);
            }

            function closeModal(modal) {
                const modalContent = modal ? modal.querySelector('div') : null;
                if (modal) {
                    modal.classList.add('opacity-0');
                    if (modalContent) modalContent.classList.add('scale-95');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            }


            function showConfirmModal() {
                const modal = document.getElementById('confirmModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        modal.classList.remove('opacity-0');
                    }, 10);
                }
            }

            function hideConfirmModal() {
                const modal = document.getElementById('confirmModal');
                if (modal) {
                    modal.classList.add('opacity-0');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            }

            function setupConfirmModal() {
                const confirmBtn = document.getElementById('confirm-reset-btn');
                const cancelBtn = document.getElementById('cancel-reset-btn');

                if (confirmBtn) {
                    confirmBtn.addEventListener('click', () => {
                        localStorage.removeItem('challengeProgress');
                        localStorage.removeItem('challengeStartDate');
                        localStorage.removeItem('shuffledJournalPrompts');
                        localStorage.removeItem('shuffledStoicQuotes'); 
                        initializeProgress();
                        renderDayGrid();
                        updateDashboard();
                        hideConfirmModal();
                    });
                }

                if (cancelBtn) {
                    cancelBtn.addEventListener('click', hideConfirmModal);
                }
            }

            function showConfettiMessage() {
                const messageEl = document.getElementById('confettiMessage');
                const messages = challengeData.confettiMessages;
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];

                messageEl.textContent = randomMessage;
                messageEl.classList.remove('hidden');

                setTimeout(() => {
                    messageEl.style.opacity = 1;
                }, 10);

                setTimeout(() => {
                    messageEl.style.opacity = 0;
                    setTimeout(() => {
                        messageEl.classList.add('hidden');
                    }, 500);
                }, 2000);
            }

            function updateOverallProgressChart() {
                const daysCompleteCount = progressData.filter(day => Object.values(day.tasks).every(t => t)).length;
                const completionPercentage = (daysCompleteCount / 30) * 100 || 0;
                const percentageEl = document.getElementById('overall-progress-percentage');
                if(percentageEl) {
                    percentageEl.textContent = `${Math.round(completionPercentage)}%`;
                }
            }

            function updateStoicQuote() {
                const quoteEl = document.getElementById('stoic-quote');
                if (!quoteEl) return;
                const today = new Date();
                const startDate = new Date(challengeStartDate);
                const challengeDay = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
                const quoteIndex = Math.min(challengeDay - 1, challengeData.stoicQuotes.length - 1);
                quoteEl.textContent = `"${challengeData.stoicQuotes[quoteIndex]}"`;
            }

            function updateCurrentDate() {
                const dateEl = document.getElementById('current-date');
                if (!dateEl) return;
                const today = new Date();
                const formattedDate = today.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                dateEl.textContent = formattedDate;
            }

            function init() {
                initializeProgress();
                updateOverallProgressChart();
                renderDayGrid();
                updateDashboard();
                setupEventListeners();
                updateCurrentDate();
            }

            init();
        });
    </script>

</body>
</html>
